<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-commerce Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #e0e4e5; color: #333; overflow: hidden; }
    .app { display: flex; height: 100vh; }
    .sidebar { width: 240px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid #e0e0e0; }
    .sidebar-header h2 { font-size: 18px; font-weight: 600; }
    .nav-menu { flex: 1; padding: 10px; }
    .nav-item { padding: 12px 16px; margin-bottom: 4px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
    .nav-item:hover { background: #f5f5f5; }
    .nav-item.active { background: #007bff; color: white; }
    .badge { margin-left: auto; background: #007bff; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    .nav-item.active .badge { background: white; color: #007bff; }
    .main { flex: 1; display: flex; flex-direction: column; background: white; }
    .topbar { padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: white; }
    .topbar h1 { font-size: 20px; font-weight: 600; }
    .user-info { display: flex; align-items: center; gap: 10px; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: #007bff; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
    .content-view { flex: 1; overflow-y: auto; padding: 20px; background: #fafafa; display: none; }
    .content-view.active { display: block; }
    .stream { max-width: 900px; margin: 0 auto; }
    .msg { margin-bottom: 20px; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .msg .text { padding: 12px 16px; border-radius: 12px; display: inline-block; max-width: 80%; word-wrap: break-word; }
    .msg.user .text { background: #007bff; color: white; margin-left: auto; float: right; }
    .msg.ai .text { background: white; color: #333; border: 1px solid #e0e0e0; }
    .product-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 16px; display: flex; gap: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .thumb { width: 120px; height: 120px; background: #f5f5f5; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .prod-meta { flex: 1; }
    .prod-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .prod-price { font-size: 18px; font-weight: 700; color: #007bff; margin-bottom: 8px; }
    .action-btns { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; max-width: 1200px; margin: 0 auto; }
    .grid-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; transition: transform 0.2s; cursor: pointer; }
    .grid-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .grid-card img { width: 100%; height: 200px; object-fit: cover; background: #f5f5f5; }
    .grid-card-content { padding: 16px; }
    .grid-card-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .grid-card-price { font-size: 18px; font-weight: 700; color: #007bff; }
    .timeline { max-width: 600px; margin: 20px auto; }
    .timeline-item { display: flex; gap: 16px; margin-bottom: 24px; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: 15px; top: 32px; bottom: -24px; width: 2px; background: #e0e0e0; }
    .timeline-item:last-child::before { display: none; }
    .timeline-dot { width: 32px; height: 32px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-size: 16px; z-index: 1; }
    .timeline-dot.completed { background: #28a745; color: white; }
    .timeline-content { flex: 1; padding-top: 4px; }
    .timeline-title { font-weight: 600; margin-bottom: 4px; }
    .timeline-date { font-size: 13px; color: #999; }
    .btn { padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-secondary { background: #f5f5f5; color: #666; border: 1px solid #e0e0e0; }
    .btn-secondary:hover { background: #e8e8e8; }
    .btn-small { padding: 6px 12px; font-size: 13px; }
    .composer { border-top: 1px solid #e0e0e0; background: white; padding: 15px 20px; }
    .composer-inner { max-width: 900px; margin: 0 auto; display: flex; gap: 10px; align-items: flex-end; }
    .composer-text { flex: 1; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 8px; resize: none; font-family: inherit; font-size: 14px; min-height: 40px; max-height: 120px; }
    .composer-text:focus { border-color: #007bff; outline: none; }
    .empty-state { text-align: center; padding: 60px 20px; color: #999; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .section-header { margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e0e0e0; }
    .section-header h2 { font-size: 20px; font-weight: 600; }
    .section-header .subtitle { font-size: 14px; color: #666; margin-top: 4px; }
    .cart-summary { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; margin-top: 20px; max-width: 400px; margin-left: auto; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px; }
    .summary-row.total { font-size: 18px; font-weight: 600; padding-top: 12px; border-top: 2px solid #e0e0e0; }
    .muted { color: #999; }
    .recommendations-section { margin-bottom: 40px; }
    .rec-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
    .order-card { background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .order-header { display: flex; justify-content: space-between; margin-bottom: 12px; }
    .order-id { font-weight: 600; }
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
    .status-confirmed { background: #cce5ff; color: #004085; }
    .status-shipped { background: #d1ecf1; color: #0c5460; }
    .status-delivered { background: #d4edda; color: #155724; }
  </style>
</head>
<body>
  <div id="app" class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>E-Commerce chatbot</h2>
      </div>
      <nav class="nav-menu">
        <div class="nav-item active" data-view="chat">Chat</div>
        <div class="nav-item" data-view="recommendations">For You</div>
        <div class="nav-item" data-view="orders">Orders <span class="badge" id="ordersBadge">0</span></div>
        <div class="nav-item" data-view="cart">Cart <span class="badge" id="cartBadge">0</span></div>
        <div class="nav-item" data-view="wishlist">Wishlist <span class="badge" id="wishlistBadge">0</span></div>
        <div class="nav-item" data-view="favorites">Favorites <span class="badge" id="favoritesBadge">0</span></div>
      </nav>
    </aside>

    <main class="main">
      <header class="topbar">
        <h1 id="pageTitle">Chat Assistant</h1>
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <span id="userName">Guest</span>
        </div>
      </header>

      <section id="chatView" class="content-view active">
        <div id="stream" class="stream"></div>
      </section>

      <section id="recommendationsView" class="content-view">
        <div id="recommendationsContent"></div>
      </section>

      <section id="ordersView" class="content-view">
        <div class="section-header">
          <h2>My Orders</h2>
          <p class="subtitle">Track your orders and view history</p>
        </div>
        <div id="ordersContent"></div>
      </section>

      <section id="cartView" class="content-view">
        <div class="section-header">
          <h2>Shopping Cart</h2>
          <p class="subtitle">Review items before checkout</p>
        </div>
        <div id="cartContent"></div>
        <div class="cart-summary" id="cartSummary" style="display:none;">
          <div class="summary-row"><span>Subtotal</span><span id="subtotal">Rs0.00</span></div>
          <div class="summary-row"><span>Tax</span><span id="tax">Rs0.00</span></div>
          <div class="summary-row total"><span>Total</span><span id="total">Rs0.00</span></div>
          <button class="btn btn-primary" style="width:100%; margin-top:16px;" onclick="placeOrder()">Place Order</button>
        </div>
      </section>

      <section id="wishlistView" class="content-view">
        <div class="section-header">
          <h2>My Wishlist</h2>
          <p class="subtitle">Items you want to buy later</p>
        </div>
        <div id="wishlistContent"></div>
      </section>

      <section id="favoritesView" class="content-view">
        <div class="section-header">
          <h2>My Favorites</h2>
          <p class="subtitle">Your most loved products</p>
        </div>
        <div id="favoritesContent"></div>
      </section>

      <footer class="composer" id="composer">
        <div class="composer-inner">
          <textarea id="composerInput" class="composer-text" placeholder='Ask: "price of denim jeans", "track my order", "my cart"' rows="1"></textarea>
          <button id="sendBtn" class="btn btn-primary">Send</button>
        </div>
      </footer>
    </main>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const USER_ID = 'guest'; // Single user for demo
    let messages = [];

    function escapeHtml(s) {
      return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.view;
        switchView(view);
      });
    });

    function switchView(view) {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      document.querySelector(`[data-view="${view}"]`).classList.add('active');
      document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
      document.getElementById(view + 'View').classList.add('active');
      document.getElementById('composer').style.display = view === 'chat' ? 'block' : 'none';
      document.getElementById('pageTitle').textContent = {
        chat: 'Chat Assistant', recommendations: 'Product Recommended for You', orders: 'My Orders',
        cart: 'Shopping Cart', wishlist: 'My Wishlist', favorites: 'My Favorites'
      }[view];
      loadViewContent(view);
    }

    async function loadViewContent(view) {
      if (view === 'recommendations') await loadRecommendations();
      if (view === 'orders') await loadOrders();
      if (view === 'cart') await loadCart();
      if (view === 'wishlist') await loadWishlist();
      if (view === 'favorites') await loadFavorites();
      updateBadges();
    }

    // Chat
    async function sendQuery() {
      const input = document.getElementById('composerInput');
      const q = input.value.trim();
      if (!q) return;
      messages.push({ role: 'user', text: q });
      renderStream();
      input.value = '';

      try {
        const resp = await fetch(`${API_BASE}/query`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: q })
        });
        const data = await resp.json();
        messages.push({ role: 'assistant', text: data.response || 'No response' });
        if (data.products?.[0]) messages.push({ role: 'product', product: data.products[0] });
        renderStream();
      } catch (err) {
        messages.push({ role: 'assistant', text: 'Error: ' + err.message });
        renderStream();
      }
    }

    function renderStream() {
      const stream = document.getElementById('stream');
      stream.innerHTML = '';
      messages.forEach(m => {
        const el = document.createElement('div');
        el.className = 'msg ' + (m.role === 'user' ? 'user' : 'ai');
        if (m.role === 'product') {
          const p = m.product;
          const img = p.image ? `${API_BASE}/images/${encodeURIComponent(p.image)}` : '';
          el.innerHTML = `
            <div class="product-card">
              <div class="thumb">
                <img src="${img}" onerror="this.src='https://via.placeholder.com/120/cccccc/666666?text=No+Image'" />
              </div>
              <div class="prod-meta">
                <h4 class="prod-title">${escapeHtml(p.name)}</h4>
                <div class="prod-price">Rs${p.cost?.toFixed(2)} • ⭐ ${p.rating?.toFixed(1)}</div>
                <div class="action-btns">
                  <button class="btn btn-primary btn-small" onclick="addTo('cart', '${escapeHtml(p.name)}')">Add to Cart</button>
                  <button class="btn btn-secondary btn-small" onclick="addTo('wishlist', '${escapeHtml(p.name)}')">Wishlist</button>
                  <button class="btn btn-secondary btn-small" onclick="addTo('favorite', '${escapeHtml(p.name)}')">Favorite</button>
                </div>
              </div>
            </div>`;
        } else {
          el.innerHTML = `<div class="text">${escapeHtml(m.text)}</div>`;
        }
        stream.appendChild(el);
      });
      stream.scrollTop = stream.scrollHeight;
    }

    async function addTo(type, name) {
      await fetch(`${API_BASE}/user/action`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: type, product: name })
      });
      alert(name + ' added to ' + type + '!');
      updateBadges();
    }

    async function updateBadges() {
      const user = await (await fetch(`${API_BASE}/user/data`)).json();
      document.getElementById('cartBadge').textContent = user.cart?.length || 0;
      document.getElementById('wishlistBadge').textContent = user.wishlist?.length || 0;
      document.getElementById('favoritesBadge').textContent = user.favorites?.length || 0;
    }

    async function loadRecommendations() {
      const el = document.getElementById('recommendationsContent');
      el.innerHTML = '<p>Loading...</p>';
      const recs = await (await fetch(`${API_BASE}/recommend`)).json();
      if (!recs.recommendations?.length) {
        el.innerHTML = '<div class="empty-state"><div class="icon">No recommendations</div><p>Start chatting!</p></div>';
        return;
      }
      el.innerHTML = `<div class="grid-container">${recs.recommendations.map(p => `
        <div class="grid-card">
          <img src="${API_BASE}/images/${encodeURIComponent(p.image)}" 
     onerror="this.src='https://via.placeholder.com/200/cccccc/666666?text=No+Image'" 
     style="width:100%; height:200px; object-fit:cover;" />

          <div class="grid-card-content">
            <div class="grid-card-title">${escapeHtml(p.name)}</div>
            <div class="grid-card-price">Rs${p.cost?.toFixed(2)}</div>
            <button class="btn btn-primary btn-small" onclick="addTo('cart', '${escapeHtml(p.name)}')">Add to Cart</button>
          </div>
        </div>`).join('')}</div>`;
    }

    async function loadOrders() {
      const el = document.getElementById('ordersContent');
      const orders = await (await fetch(`${API_BASE}/user/orders`)).json();
      if (!orders.orders?.length) {
        el.innerHTML = '<div class="empty-state"><div class="icon">No orders</div><p>You have no orders yet</p></div>';
        return;
      }
      el.innerHTML = orders.orders.map(o => `
        <div class="order-card">
          <div class="order-header">
            <div><div class="order-id">Order #${o.order_id}</div></div>
            <span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span>
          </div>
          <div>Shipping: ${o.shipping_date} • Tracking: ${o.tracking}</div>
          <div class="timeline">
            <div class="timeline-item"><div class="timeline-dot completed">Checkmark</div><div class="timeline-content"><div class="timeline-title">Order Confirmed</div><div class="timeline-date">${o.order_date.split('T')[0]}</div></div></div>
            <div class="timeline-item"><div class="timeline-dot ${o.status === 'Shipped' || o.status === 'Delivered' ? 'completed' : ''}">Truck</div><div class="timeline-content"><div class="timeline-title">Shipped</div><div class="timeline-date">${o.shipping_date}</div></div></div>
            <div class="timeline-item"><div class="timeline-dot ${o.status === 'Delivered' ? 'completed' : ''}">House</div><div class="timeline-content"><div class="timeline-title">Delivered</div><div class="timeline-date">${new Date(Date.now() + 5*24*60*60*1000).toISOString().split('T')[0]}</div></div></div>
          </div>
        </div>`).join('');
      document.getElementById('ordersBadge').textContent = orders.orders.length;
    }

    async function loadCart() {
      const user = await (await fetch(`${API_BASE}/user/data`)).json();
      const el = document.getElementById('cartContent');
      const summary = document.getElementById('cartSummary');
      if (!user.cart?.length) {
        el.innerHTML = '<div class="empty-state"><div class="icon">Cart empty</div><p>Add items from chat!</p></div>';
        summary.style.display = 'none';
        return;
      }
      el.innerHTML = user.cart.map(p => `<div class="product-card"><div class="prod-meta"><div class="prod-title">${escapeHtml(p)}</div></div></div>`).join('');
      summary.style.display = 'block';
      document.getElementById('subtotal').textContent = 'Rs' + (user.cart.length * 150).toFixed(2);
      document.getElementById('tax').textContent = 'Rs' + (user.cart.length * 20).toFixed(2);
      document.getElementById('total').textContent = 'Rs' + (user.cart.length * 170).toFixed(2);
    }

    async function loadWishlist() {
      const user = await (await fetch(`${API_BASE}/user/data`)).json();
      const el = document.getElementById('wishlistContent');
      el.innerHTML = user.wishlist?.length ? user.wishlist.map(p => `<div class="product-card"><div class="prod-meta"><div class="prod-title">${escapeHtml(p)}</div></div></div>`).join('') : '<div class="empty-state"><div class="icon">Empty</div></div>';
    }

    async function loadFavorites() {
      const user = await (await fetch(`${API_BASE}/user/data`)).json();
      const el = document.getElementById('favoritesContent');
      el.innerHTML = user.favorites?.length ? user.favorites.map(p => `<div class="product-card"><div class="prod-meta"><div class="prod-title">${escapeHtml(p)}</div></div></div>`).join('') : '<div class="empty-state"><div class="icon">Empty</div></div>';
    }

    async function placeOrder() {
      if (confirm('Place order?')) {
        await fetch(`${API_BASE}/user/order`, { method: 'POST' });
        alert('Order placed! Check Orders tab.');
        switchView('orders');
      }
    }

    // Init
    document.getElementById('sendBtn').onclick = sendQuery;
    document.getElementById('composerInput').addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendQuery(); } });
    updateBadges();
    loadRecommendations();
  </script>
</body>
</html>